{% extends "layout.html" %}
{% load static %}
{% block content %}
    <div class="page-table-container" id="debtors-container">
        <div id="context-menu" class="dropdown-menu">
            {% if not is_supplier %}
            <a class="dropdown-item context-action"
                id="settle-debt-button"
                data-action="settle-debt">Погасить долг</a>
            <a class="dropdown-item context-action"
                id="settle-debt-all-button"
                data-action="settle-debt-all">Погасить долг по всем</a>
            <a class="dropdown-item context-action"
                id="repayment-edit-button"
                data-action="repayment-edit">Изменить</a>
            {% endif %}
            <div class="dropdown-divider">
            </div>
            <a class="dropdown-item context-action"
               id="hide-button"
               data-action="hide">Скрыть</a>
            <a class="dropdown-item context-action"
               id="hide-all-button"
               data-action="hide-all">Скрыть все</a>
            <a class="dropdown-item context-action"
               id="show-all-button"
               data-action="show-all">Показать все</a>
        </div>
        <div class="debtors-data">
            {% if branch_debts|length > 1 %}
                <div class="debtors-header" id="branch-debts-header">
                    <h2 class="debtors-office-list__header">Дебиторка</h2>
                    <span class="debtors-total {% if total_branch_debts != 0 %}text-red{% else %}text-green{% endif %}">{{ total_branch_debts|floatformat:2 }}</span>
                </div>
            {% endif %}
            <ul class="debtors-office-list">
                {% for branch in branch_debts %}
                    <li class="debtors-office-list__item">
                        <div class="debtors-office-list__row"
                             data-target="branch-{{ forloop.counter }}">
                            <button class="debtors-office-list__toggle"
                                    type="button"
                                    aria-label="Подробнее">+</button>
                            <span class="debtors-office-list__title">{{ branch.branch }}</span>
                            {% if branch.branch != "Филиал 1" and branch.branch != "Наши ИП" %}
                            <span class="debtors-office-list__amount {% if branch.debt != 0 %}text-red{% else %}text-green{% endif %}">
                                {{ branch.debt|floatformat:2 }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="debtors-office-list__details"
                             id="branch-{{ forloop.counter }}"></div>
                    </li>
                {% endfor %}
            </ul>
            <div class="debtors-header" id="summary-header">
                {% if summary|length > 1 %}
                <h2 class="debtors-office-list__header">Кредиторка</h2>
                <span class="debtors-total {% if total_summary_debts != 0 %}text-red{% else %}text-green{% endif %}">{{ total_summary_debts|floatformat:2 }}</span>
                {% endif %}
            </div>
            <ul class="debtors-office-list">
                {% for row in summary %}
                    <li class="debtors-office-list__item">
                        <div class="debtors-office-list__row"
                             data-target="summary-{{ forloop.counter }}">
                            <button class="debtors-office-list__toggle"
                                    type="button"
                                    aria-label="Подробнее">+</button>
                            <span class="debtors-office-list__title">{{ row.name }}</span>
                            <span class="debtors-office-list__amount {% if row.amount != 0 %}text-red{% else %}text-green{% endif %}">
                                {{ row.amount|floatformat:2 }}
                            </span>
                        </div>
                        <div class="debtors-office-list__details"
                             id="summary-{{ forloop.counter }}"></div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="stats-container">
            {% if is_admin %}
            <button id="refresh-stats-button" class="stats-refresh-button" title="Обновить статистику">
                <img src="{% static 'images/arrows-rotate.svg' %}" alt="Обновить"
                     height="16"
                     width="16">
            </button>
            <h2 class="debtors-office-list__header debtors-office__header">Баланс</h2>
            <div id="balance-container"></div>
            <h2 class="debtors-office-list__header debtors-office__header debtors-office__header--top">Рентабельность капитала</h2>
            <div class="charts-container">
            <div class="chart-stats">
            <canvas id="statsChart" width="800" height="264"></canvas>
            </div>
            <div class="chart-profit">
            <canvas id="profitChart" width="40" height="264"></canvas>
            </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock content %}
{% block extra_scripts %}
    {{ block.super }}
    <script src="{% static 'main/js/main.js' %}" type="module"></script>
    <script src="{% static 'main/js/autonumeric.js' %}" defer></script>
    <script src="{% static 'main/js/chart.js' %}" type="module" defer></script>
    <script src="{% static 'main/js/chartjs-plugin-datalabels.js' %}" type="module" defer></script>
    {{ data_ids|json_script:"data-ids" }}
{% endblock extra_scripts %}
